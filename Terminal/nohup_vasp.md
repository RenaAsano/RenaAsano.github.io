# SSH を利用して一歩も動かず VASP 計算

VASP 計算のために共用 PC の前に行くのが面倒な人向け

## SSH 設定

自身の PC から VASP が入ってる PC に SSH 接続できればいいです．

## エイリアス設定

```sh
alias vasp_std='path/to/your/vasp/bin/vasp_std'
alias nohup='nohup '
```

VASP 実行ファイルへのパスは普通に通していいと思うけど，うちはなぜかエイリアスになってました．

## 実際の操作

### SSH 接続

```sh
ssh your_vasp_pc
cd your_work_dir
```

~/.ssh/config で色々設定してある前提の接続方法です．

### VASP 実行

```sh
nohup vasp_std > out.log &
```

標準出力を out.log へリダイレクトして記録します．このコマンドは `ctrl + C` で中断されません．

### 出力の監視

```sh
tail -f out.log
```

リアルタイムに出力を見られます．他のことをしたくなったら `ctrl + C` で中断．

### 実行状況の確認

#### `jobs` で確認

```sh
jobs
```

ディレクトリの表示もしてくれて嬉しい．一度ログアウトしてしまうと表示されない．

#### `ps` で確認

```sh
ps ux | grep vasp
```

`ps ux` コマンドで今実行されている処理の一覧を得て，その中から vasp_* コマンドの情報を掴み取ります．

#### Chat GPT に関数を作成してもらった

仕様をざっくり決めてこう頼みました．

> バックグラウンドで実行した`vasp_*`というプロセスのプロセスID，実行開始時間，実行時間，ディレクトリの場所を見出しつきで表示するbash関数を作成してください．
>
> - プロセスは `nohup` コマンドを用いて実行されます．
> - 先頭行として，プロセスIDに`PID`，実行開始時間に`START`，実行時間に`TIME`，ディレクトリの場所に`DIR`という見出しをつけてください．
> - 関数名は`ps_vasp`としてください．

作ってくれた関数を試して，修正を依頼．

> ありがとう．さっそく実行してみました．
>
> - `TIME`列は不要だったので削除して，その分`DIR`の表示文字数を増やしてください．ただし全体で1行を80文字以内に収めてください．
> - 出力に `ps_vasp: 15: [[: not found`と表示されています．原因と，このエラーまたは警告が出ないように修正したコードを教えてください．

その後細かい調整を手動で行った完成品がこちら．

```sh
ps_vasp() {
    # プロセスID，実行開始時間，ディレクトリの場所の見出しを表示
    printf "%-10s %-24s %s\n" "PID" "START" "DIR"
    printf "%-10s %-24s %s\n" "----------" "------------------------" "---------
----------------------------------"

    # バックグラウンドで実行されたプロセス `vasp_*` を検索し、情報を表示
    for pid in $(pgrep -f "vasp_*"); do
        # プロセスの開始時間を取得
        start_time=$(ps -o lstart= -p $pid)

        # プロセスが実行されたディレクトリの場所を取得
        proc_dir=$(readlink -f /proc/$pid/cwd)

        # プロセスの情報を表示
        printf "%-10s %-20s %s\n" "$pid" "$start_time" "$proc_dir"
    done
}
```

シェルまだまだよく知らないので一人じゃ絶対作れません．

```sh
$ ps_vasp
PID        START                    DIR
---------- ------------------------ -------------------------------------------
your_PID   Tue Mar DD HH:mm:ss YYYY /absolute/path/to/dir1
```

### 計算の中断

#### `jobs` と `fg` で中断

ログアウト前なら使用可能

```sh
$ jobs
[1]
$ fg 1
```

この後 `ctrl + C` で中断

#### `kill` で中断

```sh
$ ps_vasp
PID        START                    DIR
---------- ------------------------ -------------------------------------------
your_PID   Tue Mar DD HH:mm:ss YYYY /absolute/path/to/dir1
```

左端のプロセス ID を使用して

```sh
kill -9 your_PID
```
